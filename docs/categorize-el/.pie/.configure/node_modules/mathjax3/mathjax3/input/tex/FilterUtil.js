"use strict";
var __values = (this && this.__values) || function (o) {
    var m = typeof Symbol === "function" && o[Symbol.iterator], i = 0;
    if (m) return m.call(o);
    return {
        next: function () {
            if (o && i >= o.length) o = void 0;
            return { value: o && o[i++], done: !o };
        }
    };
};
Object.defineProperty(exports, "__esModule", { value: true });
var MmlNode_js_1 = require("../../core/MmlTree/MmlNode.js");
var NodeUtil_js_1 = require("./NodeUtil.js");
var FilterUtil;
(function (FilterUtil) {
    FilterUtil.cleanStretchy = function (arg) {
        var options = arg.data;
        try {
            for (var _a = __values(options.getList('fixStretchy')), _b = _a.next(); !_b.done; _b = _a.next()) {
                var mo = _b.value;
                if (NodeUtil_js_1.default.getProperty(mo, 'fixStretchy')) {
                    var symbol = NodeUtil_js_1.default.getForm(mo);
                    if (symbol && symbol[3] && symbol[3]['stretchy']) {
                        NodeUtil_js_1.default.setAttribute(mo, 'stretchy', false);
                    }
                    var parent_1 = mo.parent;
                    if (!NodeUtil_js_1.default.getTexClass(mo) && (!symbol || !symbol[2])) {
                        var texAtom = options.nodeFactory.create('node', 'TeXAtom', [mo]);
                        parent_1.replaceChild(texAtom, mo);
                        texAtom.setInheritedAttributes({}, arg.math['display'], parent_1.attributes.get('scriptlevel'), parent_1.getProperty('texprimestyle'));
                    }
                    NodeUtil_js_1.default.removeProperties(mo, 'fixStretchy');
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (_b && !_b.done && (_c = _a.return)) _c.call(_a);
            }
            finally { if (e_1) throw e_1.error; }
        }
        var e_1, _c;
    };
    FilterUtil.cleanAttributes = function (arg) {
        var node = arg.data.root;
        node.walkTree(function (mml, d) {
            var attribs = mml.attributes;
            try {
                for (var _a = __values(attribs.getExplicitNames()), _b = _a.next(); !_b.done; _b = _a.next()) {
                    var key = _b.value;
                    if (attribs.attributes[key] === mml.attributes.getInherited(key)) {
                        delete attribs.attributes[key];
                    }
                }
            }
            catch (e_2_1) { e_2 = { error: e_2_1 }; }
            finally {
                try {
                    if (_b && !_b.done && (_c = _a.return)) _c.call(_a);
                }
                finally { if (e_2) throw e_2.error; }
            }
            var e_2, _c;
        }, {});
    };
    FilterUtil.combineRelations = function (arg) {
        try {
            for (var _a = __values(arg.data.getList('mo')), _b = _a.next(); !_b.done; _b = _a.next()) {
                var mo = _b.value;
                if (mo.getProperty('relationsCombined') || !mo.parent ||
                    (mo.parent && !NodeUtil_js_1.default.isType(mo.parent, 'mrow'))) {
                    continue;
                }
                var mml = mo.parent;
                var m1 = void 0, m2 = void 0;
                var children = mml.childNodes;
                for (var i = 0, m = children.length; i < m; i++) {
                    if (!children[i]) {
                        break;
                    }
                    while (i + 1 < m && (m1 = children[i]) && (m2 = children[i + 1]) &&
                        NodeUtil_js_1.default.isType(m1, 'mo') && NodeUtil_js_1.default.isType(m2, 'mo') &&
                        NodeUtil_js_1.default.getTexClass(m1) === MmlNode_js_1.TEXCLASS.REL &&
                        NodeUtil_js_1.default.getTexClass(m2) === MmlNode_js_1.TEXCLASS.REL) {
                        m2.setProperty('relationsCombined', true);
                        if (NodeUtil_js_1.default.getProperty(m1, 'variantForm') ===
                            NodeUtil_js_1.default.getProperty(m2, 'variantForm') &&
                            NodeUtil_js_1.default.getAttribute(m1, 'mathvariant') ===
                                NodeUtil_js_1.default.getAttribute(m2, 'mathvariant')) {
                            NodeUtil_js_1.default.appendChildren(m1, NodeUtil_js_1.default.getChildren(m2));
                            children.splice(i + 1, 1);
                            m2.parent = null;
                            m1.attributes.setInherited('form', m1.getForms()[0]);
                            m--;
                        }
                        else {
                            NodeUtil_js_1.default.setAttribute(m1, 'rspace', '0pt');
                            NodeUtil_js_1.default.setAttribute(m2, 'lspace', '0pt');
                            i++;
                        }
                    }
                }
            }
        }
        catch (e_3_1) { e_3 = { error: e_3_1 }; }
        finally {
            try {
                if (_b && !_b.done && (_c = _a.return)) _c.call(_a);
            }
            finally { if (e_3) throw e_3.error; }
        }
        var e_3, _c;
    };
    var _cleanSubSup = function (options, low, up) {
        try {
            for (var _a = __values(options.getList('m' + low + up)), _b = _a.next(); !_b.done; _b = _a.next()) {
                var mml = _b.value;
                var children = mml.childNodes;
                if (children[mml[low]] && children[mml[up]]) {
                    continue;
                }
                var parent_2 = mml.parent;
                var newNode = (children[mml[low]] ?
                    options.nodeFactory.create('node', 'm' + low, [children[mml.base], children[mml[low]]]) :
                    options.nodeFactory.create('node', 'm' + up, [children[mml.base], children[mml[up]]]));
                NodeUtil_js_1.default.copyAttributes(mml, newNode);
                if (parent_2) {
                    parent_2.replaceChild(newNode, mml);
                }
                else {
                    options.root = newNode;
                }
            }
        }
        catch (e_4_1) { e_4 = { error: e_4_1 }; }
        finally {
            try {
                if (_b && !_b.done && (_c = _a.return)) _c.call(_a);
            }
            finally { if (e_4) throw e_4.error; }
        }
        var e_4, _c;
    };
    FilterUtil.cleanSubSup = function (arg) {
        var options = arg.data;
        if (options.error) {
            return;
        }
        _cleanSubSup(options, 'sub', 'sup');
        _cleanSubSup(options, 'under', 'over');
        options.root.setInheritedAttributes({}, arg.math['display'], 0, false);
    };
})(FilterUtil || (FilterUtil = {}));
exports.default = FilterUtil;
//# sourceMappingURL=FilterUtil.js.map